#第03課 格子地圖


#####執行結果:
![GitHub Logo](/screen/results03-1.png)


#####檔案放置方式:
```
   |___index.html
   |
   |___<css>
   |     |___main.css
   | 	 
   |___<js>
   |     |___MyCanvas.js  
   |     |___MySprite.js 
   |     |___SpriteImg.js
   |     |___Map.js   
   |     
   |___<images>
         |___a_1.png  
         |___map_1.png          
```


#####檔案名稱: index.html
```html
<!doctype html> 
<html> 
<head> <meta charset="utf-8">
<title> 動畫測試 </title> 

<link rel="stylesheet" href="css/main.css"/>

<script src="js/MyCanvas.js"></script>
<script src="js/SpriteImg.js"></script>
<script src="js/MySprite.js"></script>
<script src="js/Map.js"></script>

<script>
//==================
// 設定廣域變數
//==================
var myCanvas;   //畫布
var sprite;     //主角
var myMap;      //地圖

var imgCnt=2;   //需載入圖片數


//====================================  
// 初始畫布物件(1個), 主角圖片物件(1個)
//====================================
function init(){
    //-----------------------------------------
    // 產生<畫布>物件, 傳入:(1)畫布物件, (2)背景色
    //-----------------------------------------
    myCanvas=new MyCanvas("myCanvas", "#a0a0a0");   
    
    //----------------------------------------------
    // SpriteImg<主角圖片>物件可直接使用 myCanvas<畫布>        
    //----------------------------------------------
    SpriteImg.prototype=myCanvas;

    //-------------------------------------------------------------------------------------------
    // MySprite<主角>物件可直接使用SpriteImg<主角圖片>物件       
    // 傳入:(1)主角圖片, (2)每個影格寬, (3)每個影格高, (4)每個完整動作有幾個影格, (5)載完圖片後的callback函式
    //-------------------------------------------------------------------------------------------
    MySprite.prototype=new SpriteImg('images/a_1.png', imageLoaded);
	
    //-------------------------------------
    // Map<地圖>物件可直接使用 myCanvas<畫布>
    //-------------------------------------
    Map.prototype=myCanvas;
	
    //---------------------------------------------		
    // 生成地圖物件
    // 傳入:(1)地圖圖片, (2)載完圖片後的callback函式
    //---------------------------------------------
    myMap=new Map('images/map_1.png', imageLoaded);	
}


//===============================
// 檢查動畫使用的圖片是否均已載入
//===============================
function imageLoaded(){
    imgCnt--;
	
    //------------------
    // 如果圖片已載入完成
    //------------------
    if(imgCnt==0){  
        //----------  
        // 建立主角 
        //----------
        sprite=new MySprite(0, 0, 0, 'fast'); 
		
        //-------------------
        // 如果使用者按下鍵盤
        //-------------------   
        document.onkeydown=function(e){            
            control(e.keyCode);
        }
		
        //-----------------------
        // 每隔一段時間執行主要流程
        //-----------------------   
        setInterval(main, 30);      
    }
}


//================
// 鍵盤動作
//================
function control(keyCode){  
    if(keyCode==37){sprite.nextDirection='left';}   //左               
    if(keyCode==38){sprite.nextDirection='up';}     //上                       
    if(keyCode==39){sprite.nextDirection='right';}  //右            
    if(keyCode==40){sprite.nextDirection='down';}   //下
    if(keyCode==32){sprite.nextDirection='stop';}   //停止 
}


//================
// 動畫主要流程
//================
function main(){    
    //清除畫布
    myCanvas.clearScreen();
	
    // 畫地圖
    myMap.draw();

    //畫主角
    sprite.walk();
}
</script>
</head> 

<body onLoad="init()"> 
    <div class="main" align="center"> 
        <canvas id="myCanvas" width="800" height="800"> 
        </canvas> 
    </div> 
</body>
</html>
```



#####檔案名稱: main.css
```css
@charset "utf-8";

html, body{
    background:#000;
}
```



#####檔案名稱: MyCanvas.js
```js
//========================================
// <畫布>建構元函式
//========================================
function MyCanvas(canvasId, background){
    this.canvas=document.getElementById(canvasId);
    this.context=this.canvas.getContext("2d");
	
    // 取得繪圖介面
    this.getContext=function(){
		    return this.context;
    }
	
    // 清除畫布
    this.clearScreen=function(){
        this.context.fillStyle = background;
        this.context.fillRect (0, 0, this.canvas.width, this.canvas.height);
    }			
}
```


#####檔案名稱: SpriteImg.js
```js
//==================================
// <主角圖片>建構元函式
//==================================
function SpriteImg(imageName, callback){	
    // 主角圖片	
    this.image=new Image();
    this.image.src=imageName;
	
    //如果圖片載入完成, 執行imageLoaded函式
    this.image.onload=function(event){		
        callback();
    }
}
```


#####檔案名稱: MySprite.js
```js
//=================================
// <主角>建構元函式
//=================================
function MySprite(gridX, gridY, direction, speed){
    //================
    // 主角使用的變數	
    //================	
    // 速度值
    var normalSpeed=150;
    var fastSpeed=100;
    var slowSpeed=200;	
	
    // 每步的距離
    var distance=4;
	
    // 單一影格寬及高
    var frameWidth=32;
    var frameHeight=48;
	
    // 每個方向由幾張圖組合而成
    var framesPerWalk=4;

    // (0,0)與畫布左上角之距離
    var offset_x=80;  
    var offset_y=80;		

    // 晝在格子內的位差
    var gridLow=24;
    
    // 畫在畫布上的絕對位置
    var x, y;	
		
    //目前顯示的圖片影格, 每個橫列有4張圖, 0~3
    var frame;    
		
		
    //============	
    // 主角的屬性	
    //============	
    // 初始座標(0~19)
    this.gridX=gridX;
    this.gridY=gridY;
	
    // 方向(0下, 1左, 2右, 3上)
    this.direction=direction;			
	
    // normal, fast 及 slow
    this.speed=speed;

    // 0:停止, 1~8:移動(一個完整的步閥有8個分解動作, 每個分解動作移動4px, 4*8=32px)    
    this.step=0;   
	
    // 主角的下一個方向或停止
    this.nextDirection='';
	
    // 上一次切換影格的時間
    this.lastMsec=0;   

	
    //----------------------------------
    // 在大圖切一塊影格 [w, h], 畫在畫布上
    //----------------------------------
    this.walk=function(){
        // 計算主角畫在畫布上的絕對位置
        this.setPosition();	    
		 
 
        //如果主角在移動中, 一個移動循環的step為1~8, 共移動1個方格(32 pixels)    		
        if(this.step>0){        
            //切換動畫影格
            this.frame=this.step%framesPerWalk;     
		    
            //在絕對位置座標上畫上影格
            this.context.drawImage(this.image, frameWidth*this.frame, this.direction*frameHeight, frameWidth, frameHeight, x, y, frameWidth, frameHeight);      
		   
            // 取得現在時間
            var thisMsec=(new Date()).getTime();

            // 如果達到切換時間
            var duration=normalSpeed;
            if(this.speed=='normal'){duration=normalSpeed;}
            if(this.speed=='fast'){duration=fastSpeed;}
            if(this.speed=='slow'){duration=slowSpeed;}

            if(Math.abs(thisMsec - this.lastMsec) > duration){
                //累加步數(每個方格走8步, 8*4=32像素)
                this.step++;			   
			   
                // 如果已完一個移動循環
                if(this.step==9){               
                    //方格座標改變  
                    if(this.direction==0){this.gridY++;}
                    if(this.direction==1){this.gridX--;}
                    if(this.direction==2){this.gridX++;}
                    if(this.direction==3){this.gridY--;}  
				  
                    //如果方格座標超出邊界
                    if(this.gridX>19){this.gridX=0;}
                    if(this.gridX<0){this.gridX=19;}
                    if(this.gridY>19){this.gridY=0;}
                    if(this.gridY<0){this.gridY=19;}							  
			  
                    // 設定下一循環開始
                    this.step=1;	
				   
                    // 檢查主角的下一步動作
                    this.checkNext();				    
                }   
				
                // 重設區段開始時間  				
                this.lastMsec=thisMsec;
            }
        }else{
            // 如果主角是停止狀態
            this.context.drawImage(this.image, 0, this.direction*frameHeight, frameWidth, frameHeight, x, y, frameWidth, frameHeight);  
		
            // 檢查主角的下一步動作
            this.checkNext();
        }
    }
	
	
    //-------------------------
    // 檢查主角的下一步是何動作
    //-------------------------
    this.checkNext=function(){
        if(this.nextDirection=='left'){this.setDirection('left');}
        if(this.nextDirection=='right'){this.setDirection('right');}
        if(this.nextDirection=='up'){this.setDirection('up');}
        if(this.nextDirection=='down'){this.setDirection('down');}	 
        if(this.nextDirection=='stop'){this.setDirection('stop');}	
				   
        this.nextDirection='';  		
    }
	
	
    //-------------------
    // 設定方向
    //-------------------
    this.setDirection=function(direction){
        if(direction=='down'){
            this.direction=0;
            this.step=1;
        }
		
        if(direction=='left'){
            this.direction=1;
            this.step=1;
        }	
		
        if(direction=='right'){
            this.direction=2;
            this.step=1;
        }	
		
        if(direction=='up'){
            this.direction=3;
            this.step=1;
        }	
		
        if(direction=='stop'){
            this.step=0;
        }		
    }
	
	
    //--------------------------	
    // 計算主角畫在畫布上的絕對位置
    //--------------------------
    this.setPosition = function(){
        // 向下
        if(this.direction==0){
            x = 0 + this.gridX*frameWidth + offset_x;
            y = -gridLow + this.gridY*frameWidth + this.step*distance + offset_y;
        }
		
        // 向左
        if(this.direction==1){
            x = 0 + this.gridX*frameWidth - this.step*distance + offset_x;
            y = -gridLow + this.gridY*frameWidth + offset_y;
        }
		
        // 向右
        if(this.direction==2){
            x = 0 + this.gridX*frameWidth + this.step*distance + offset_x;
            y = -gridLow + this.gridY*frameWidth + offset_y;
        }		
		
        // 向上
        if(this.direction==3){
            x = 0 + this.gridX*frameWidth + offset_x;
            y = -gridLow + this.gridY*frameWidth - this.step*distance + offset_y;
        }		
    }
}
```



#####檔案名稱: Map.js
```js
//==================================
// <地圖>建構元函式
//==================================
function Map(imageName, callback){
    var offset_x=80;  
    var offset_y=80;	
	
    var image=new Image();
    image.src=imageName;
		

    //如果圖片載入完成, 執行setup()函式
    image.addEventListener("load", callback, false); 
	
	
    //顯示地圖
    this.draw=function(){
        this.context.drawImage(image, offset_x, offset_y); 
    } 
} 
```
